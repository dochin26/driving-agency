<div class="min-h-screen bg-base-200">
  <%= render "shared/navbar" %>

  <div class="container mx-auto p-4 max-w-4xl">
    <div class="breadcrumbs text-sm mb-4">
      <ul>
        <li><%= link_to "„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ", dashboard_path %></li>
        <li><%= link_to "ÈÅãËª¢Ë®òÈå≤", driving_records_path %></li>
        <% if @driving_record.completed? %>
          <li><%= link_to "Ë©≥Á¥∞", driving_record_path(@driving_record) %></li>
        <% end %>
        <li>Á∑®ÈõÜ</li>
      </ul>
    </div>

    <% if @driving_record.draft? %>
      <div class="alert alert-info shadow-lg mb-4">
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current flex-shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
          <span>‰∏ãÊõ∏„Åç„Åã„ÇâÁ∂ö„Åç„ÇíÂÖ•Âäõ„Åó„Åæ„Åô</span>
        </div>
      </div>
    <% end %>

    <div class="card bg-base-100 shadow-xl">
      <div class="card-body">
        <h2 class="card-title text-2xl mb-6">ÈÅãËª¢Ë®òÈå≤ Á∑®ÈõÜ</h2>

        <%= form_with(model: @driving_record, class: "space-y-6") do |f| %>
          <% if @driving_record.errors.any? %>
            <div class="alert alert-error">
              <div>
                <span class="font-bold"><%= pluralize(@driving_record.errors.count, "ÂÄã") %>„ÅÆ„Ç®„É©„Éº„Åå„ÅÇ„Çä„Åæ„ÅôÔºö</span>
                <ul class="list-disc list-inside mt-2">
                  <% @driving_record.errors.full_messages.each do |message| %>
                    <li><%= message %></li>
                  <% end %>
                </ul>
              </div>
            </div>
          <% end %>

          <!-- Âá∫Áô∫ÊÉÖÂ†± -->
          <div class="card bg-base-200">
            <div class="card-body">
              <h3 class="card-title text-lg">üìç Âá∫Áô∫ÊÉÖÂ†±</h3>

              <div class="form-control">
                <%= f.label :departure_datetime, class: "label" do %>
                  <span class="label-text">Âá∫Áô∫Êó•ÊôÇ <span class="text-error">*</span></span>
                <% end %>
                <%= f.datetime_local_field :departure_datetime,
                    class: "input input-bordered w-full",
                    required: false %>
              </div>

              <div class="form-control">
                <%= f.label :departure_note, "Âá∫Áô∫ÊÉÖÂ†±„ÅÆÂÇôËÄÉ", class: "label" %>
                <%= f.text_field :departure_note,
                    class: "input input-bordered w-full",
                    placeholder: "‰æãÔºö‚óã‚óãÂ∫ó„ÄÅ‚ñ≥‚ñ≥ÊßòÂÆÖ„Å™„Å©",
                    required: false %>
              </div>

              <div class="form-control" data-controller="geolocation">
                <%= f.label :departure_location, "Âá∫Áô∫Âú∞ÁÇπ", class: "label" %>
                <div class="flex gap-2">
                  <%= f.text_field :departure_location,
                      class: "input input-bordered flex-1 min-w-0",
                      placeholder: "ÁèæÂú®Âú∞„Éú„Çø„É≥„ÅßÂèñÂæó",
                      data: { geolocation_target: "addressField" } %>
                  <button type="button"
                          class="btn btn-secondary flex-shrink-0"
                          data-geolocation-target="button"
                          data-action="click->geolocation#getCurrentLocation">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                  </button>
                </div>
                <%= f.hidden_field :departure_latitude, data: { geolocation_target: "latitudeField" } %>
                <%= f.hidden_field :departure_longitude, data: { geolocation_target: "longitudeField" } %>
              </div>
            </div>
          </div>

          <!-- ÁµåÁî±Âú∞ -->
          <div class="card bg-base-200">
            <div class="card-body">
              <h3 class="card-title text-lg">üîÑ ÁµåÁî±Âú∞Ôºà‰ªªÊÑèÔºâ</h3>

              <div data-controller="waypoints"
                   data-waypoints-count-value="<%= @driving_record.waypoints.size %>"
                   data-waypoints-max-waypoints-value="10">
                <div data-waypoints-target="container">
                  <% @driving_record.waypoints.each_with_index do |waypoint, index| %>
                    <div class="border-2 border-base-300 p-4 rounded-lg mb-4" data-waypoint-item>
                      <%= f.fields_for :waypoints, waypoint, child_index: index do |waypoint_form| %>
                        <div class="flex justify-between items-center mb-2">
                          <label class="label-text font-bold">ÁµåÁî±Âú∞<%= index + 1 %></label>
                          <button type="button"
                                  class="btn btn-error btn-xs"
                                  data-action="click->waypoints#removeWaypoint">
                            ‚úï ÂâäÈô§
                          </button>
                        </div>

                        <%= waypoint_form.hidden_field :sequence, value: index + 1 %>
                        <%= waypoint_form.hidden_field :_destroy %>

                        <div class="form-control" data-controller="geolocation">
                          <div class="flex gap-2">
                            <%= waypoint_form.text_field :location,
                                class: "input input-bordered input-sm flex-1 min-w-0",
                                placeholder: "ÁèæÂú®Âú∞„Éú„Çø„É≥„ÅßÂèñÂæó",
                                data: { geolocation_target: "addressField" } %>
                            <button type="button"
                                    class="btn btn-secondary btn-sm flex-shrink-0"
                                    data-geolocation-target="button"
                                    data-action="click->geolocation#getCurrentLocation">
                              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                              </svg>
                            </button>
                          </div>
                          <%= waypoint_form.hidden_field :latitude, data: { geolocation_target: "latitudeField" } %>
                          <%= waypoint_form.hidden_field :longitude, data: { geolocation_target: "longitudeField" } %>
                        </div>
                      <% end %>
                    </div>
                  <% end %>
                </div>

                <button type="button"
                        class="btn btn-outline btn-sm"
                        data-action="click->waypoints#addWaypoint">
                  ‚ûï ÁµåÁî±Âú∞„ÇíËøΩÂä†
                </button>

                <!-- ÁµåÁî±Âú∞„ÉÜ„É≥„Éó„É¨„Éº„Éà -->
                <template data-waypoints-target="template">
                  <div class="border-2 border-dashed border-base-300 p-4 rounded-lg mb-4" data-waypoint-item>
                    <%= f.fields_for :waypoints, Waypoint.new, child_index: 'NEW_RECORD' do |waypoint_form| %>
                      <div class="flex justify-between items-center mb-2">
                        <label class="label-text font-bold">ÁµåÁî±Âú∞SEQUENCE</label>
                        <button type="button"
                                class="btn btn-error btn-xs"
                                data-action="click->waypoints#removeWaypoint">
                          ‚úï ÂâäÈô§
                        </button>
                      </div>

                      <%= waypoint_form.hidden_field :sequence, value: 'SEQUENCE' %>
                      <%= waypoint_form.hidden_field :_destroy %>

                      <div class="form-control" data-controller="geolocation">
                        <div class="flex gap-2">
                          <%= waypoint_form.text_field :location,
                              class: "input input-bordered input-sm flex-1 min-w-0",
                              placeholder: "ÁèæÂú®Âú∞„Éú„Çø„É≥„ÅßÂèñÂæó",
                              data: { geolocation_target: "addressField" } %>
                          <button type="button"
                                  class="btn btn-secondary btn-sm flex-shrink-0"
                                  data-geolocation-target="button"
                                  data-action="click->geolocation#getCurrentLocation">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                          </button>
                        </div>
                        <%= waypoint_form.hidden_field :latitude, data: { geolocation_target: "latitudeField" } %>
                        <%= waypoint_form.hidden_field :longitude, data: { geolocation_target: "longitudeField" } %>
                      </div>
                    <% end %>
                  </div>
                </template>
              </div>
            </div>
          </div>

          <!-- Âà∞ÁùÄ„ÉªÈÅãËª¢ÊÉÖÂ†± -->
          <div class="card bg-base-200">
            <div class="card-body">
              <h3 class="card-title text-lg">üèÅ Âà∞ÁùÄ„ÉªÈÅãËª¢ÊÉÖÂ†±</h3>

              <div class="form-control">
                <%= f.label :arrival_datetime, class: "label" do %>
                  <span class="label-text">Âà∞ÁùÄÊó•ÊôÇ</span>
                <% end %>
                <%= f.datetime_local_field :arrival_datetime,
                    class: "input input-bordered w-full" %>
              </div>

              <div class="form-control" data-controller="geolocation">
                <%= f.label :destination, "ÁõÆÁöÑÂú∞", class: "label" %>
                <div class="flex gap-2">
                  <%= f.text_field :destination,
                      class: "input input-bordered flex-1 min-w-0",
                      placeholder: "ÁèæÂú®Âú∞„Éú„Çø„É≥„ÅßÂèñÂæó",
                      data: { geolocation_target: "addressField" } %>
                  <button type="button"
                          class="btn btn-secondary flex-shrink-0"
                          data-geolocation-target="button"
                          data-action="click->geolocation#getCurrentLocation">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                  </button>
                </div>
                <%= f.hidden_field :destination_latitude, data: { geolocation_target: "latitudeField" } %>
                <%= f.hidden_field :destination_longitude, data: { geolocation_target: "longitudeField" } %>
              </div>

              <div class="form-control">
                <%= f.label :customer_id, "È°ßÂÆ¢", class: "label" %>
                <%= f.collection_select :customer_id,
                    Customer.all, :id, :name,
                    { prompt: "È°ßÂÆ¢„ÇíÈÅ∏Êäû", include_blank: "È°ßÂÆ¢„Å™„Åó" },
                    { class: "select select-bordered w-full" } %>
              </div>

              <div class="form-control">
                <%= f.label :customer_name, "È°ßÂÆ¢ÂêçÔºàÊâãÂÖ•ÂäõÔºâ", class: "label" %>
                <%= f.text_field :customer_name,
                    class: "input input-bordered w-full",
                    placeholder: "È°ßÂÆ¢„ÇíÈÅ∏Êäû„Åó„Å™„ÅÑÂ†¥Âêà„ÅØÊâãÂÖ•Âäõ" %>
              </div>

              <div class="form-control">
                <%= f.label :vehicle_id, "Ëªä‰∏°", class: "label" %>
                <%= f.collection_select :vehicle_id,
                    Vehicle.all, :id, :vehicle_number,
                    { prompt: "Ëªä‰∏°„ÇíÈÅ∏Êäû" },
                    { class: "select select-bordered w-full" } %>
              </div>

              <div class="form-control">
                <%= f.label :distance, "Ëµ∞Ë°åË∑ùÈõ¢ÔºàkmÔºâ", class: "label" %>
                <%= f.number_field :distance,
                    class: "input input-bordered w-full",
                    step: 0.1,
                    min: 0,
                    placeholder: "‰æãÔºö15.5" %>
              </div>
            </div>
          </div>

          <!-- ÊñôÈáëÊÉÖÂ†± -->
          <div class="card bg-base-200">
            <div class="card-body" data-controller="amount-calculator">
              <h3 class="card-title text-lg">üí∞ ÊñôÈáëÊÉÖÂ†±</h3>

              <div class="form-control">
                <%= f.label :fare_amount, "ÈÅãË≥É", class: "label" %>
                <%= f.number_field :fare_amount,
                    class: "input input-bordered w-full",
                    min: 0,
                    value: @driving_record.fare_amount || 0,
                    data: {
                      amount_calculator_target: "fareAmount",
                      action: "input->amount-calculator#calculate"
                    } %>
              </div>

              <div class="form-control">
                <%= f.label :highway_fee, "È´òÈÄüÊñôÈáë", class: "label" %>
                <%= f.number_field :highway_fee,
                    class: "input input-bordered w-full",
                    min: 0,
                    value: @driving_record.highway_fee || 0,
                    data: {
                      amount_calculator_target: "highwayFee",
                      action: "input->amount-calculator#calculate"
                    } %>
              </div>

              <div class="form-control">
                <%= f.label :parking_fee, "ÈßêËªäÊñôÈáë", class: "label" %>
                <%= f.number_field :parking_fee,
                    class: "input input-bordered w-full",
                    min: 0,
                    value: @driving_record.parking_fee || 0,
                    data: {
                      amount_calculator_target: "parkingFee",
                      action: "input->amount-calculator#calculate"
                    } %>
              </div>

              <div class="form-control">
                <%= f.label :other_fee, "„Åù„ÅÆ‰ªñÊñôÈáë", class: "label" %>
                <%= f.number_field :other_fee,
                    class: "input input-bordered w-full",
                    min: 0,
                    value: @driving_record.other_fee || 0,
                    data: {
                      amount_calculator_target: "otherFee",
                      action: "input->amount-calculator#calculate"
                    } %>
              </div>

              <div class="divider"></div>

              <div class="flex justify-between items-center p-4 bg-primary/10 rounded-lg">
                <span class="text-lg font-bold">ÂêàË®àÈáëÈ°ç</span>
                <span class="text-2xl font-bold text-primary" data-amount-calculator-target="totalAmount">¬•<%= number_with_delimiter(@driving_record.total_amount) %></span>
              </div>
            </div>
          </div>

          <!-- ÂÇôËÄÉ -->
          <div class="card bg-base-200">
            <div class="card-body">
              <h3 class="card-title text-lg">üìù ÂÇôËÄÉ</h3>

              <div class="form-control">
                <%= f.label :notes, class: "label" do %>
                  <span class="label-text">ÂÇôËÄÉÔºà‰ªªÊÑèÔºâ</span>
                <% end %>
                <%= f.text_area :notes,
                    class: "textarea textarea-bordered w-full",
                    rows: 3,
                    placeholder: "ÁâπË®ò‰∫ãÈ†Ö„Åå„ÅÇ„Çå„Å∞Ë®òÂÖ•„Åó„Å¶„Åè„Å†„Åï„ÅÑ" %>
              </div>
            </div>
          </div>

          <!-- ÈÄÅ‰ø°„Éú„Çø„É≥ -->
          <div class="flex gap-4 justify-end">
            <%= link_to "„Ç≠„É£„É≥„Çª„É´", driving_records_path, class: "btn btn-ghost" %>
            <%= f.submit "‰∏ãÊõ∏„Åç‰øùÂ≠ò", name: "save_draft", class: "btn btn-outline btn-primary" %>
            <%= f.submit "ÂÆå‰∫Ü„Åó„Å¶ÁôªÈå≤", name: "save_completed", class: "btn btn-primary" %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

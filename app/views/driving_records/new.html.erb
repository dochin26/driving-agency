<div class="min-h-screen bg-base-200 pb-20 md:pb-0">
  <%= render "shared/navbar" %>

  <div class="p-3 md:p-6 lg:p-8">
    <div class="max-w-4xl mx-auto">
    <!-- „Çπ„Éû„ÉõÁî®„Ç∑„É≥„Éó„É´„Éò„ÉÉ„ÉÄ„Éº -->
    <div class="flex items-center gap-3 mb-4 md:hidden">
      <%= link_to dashboard_path, class: "btn btn-ghost btn-sm btn-circle" do %>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
      <% end %>
      <h1 class="text-lg font-bold">ÈÅãËª¢Ë®òÈå≤ Êñ∞Ë¶èÁôªÈå≤</h1>
    </div>

      <!-- PCÁî®„Éë„É≥„Åè„Åö -->
      <div class="breadcrumbs text-sm mb-6 hidden md:block">
        <ul>
          <li><%= link_to "„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ", dashboard_path %></li>
          <li><%= link_to "ÈÅãËª¢Ë®òÈå≤", driving_records_path %></li>
          <li>Êñ∞Ë¶èÁôªÈå≤</li>
        </ul>
      </div>

      <div class="card bg-base-100 shadow-xl">
        <div class="card-body p-3 md:p-8">
          <h2 class="card-title text-xl md:text-2xl mb-6 hidden md:block">ÈÅãËª¢Ë®òÈå≤ Êñ∞Ë¶èÁôªÈå≤</h2>

        <%= form_with(model: @driving_record, class: "space-y-4 md:space-y-6") do |f| %>
          <% if @driving_record.errors.any? %>
            <div class="alert alert-error shadow-md text-sm">
              <div>
                <span class="font-bold"><%= pluralize(@driving_record.errors.count, "ÂÄã") %>„ÅÆ„Ç®„É©„Éº</span>
                <ul class="list-disc list-inside mt-2 text-xs">
                  <% @driving_record.errors.full_messages.each do |message| %>
                    <li><%= message %></li>
                  <% end %>
                </ul>
              </div>
            </div>
          <% end %>

          <!-- Âá∫Áô∫ÊÉÖÂ†± -->
          <div class="card bg-base-200/50">
            <div class="card-body p-4 md:p-6">
              <div class="flex items-center gap-2 mb-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                <h3 class="font-bold text-base">Âá∫Áô∫ÊÉÖÂ†±</h3>
              </div>

              <div class="form-control">
                <%= f.label :departure_datetime, class: "label" do %>
                  <span class="label-text text-sm font-medium">Âá∫Áô∫Êó•ÊôÇ <span class="text-error">*</span></span>
                <% end %>
                <%= f.datetime_local_field :departure_datetime,
                    class: "input input-bordered w-full input-md",
                    required: false %>
              </div>

              <div class="form-control">
                <%= f.label :store_id, class: "label" do %>
                  <span class="label-text text-sm font-medium">Â∫óËàó</span>
                <% end %>
                <%= f.collection_select :store_id,
                    Store.all, :id, :name,
                    { prompt: "Â∫óËàó„ÇíÈÅ∏Êäû", include_blank: "ÊâãÂÖ•Âäõ„Åô„Çã" },
                    { class: "select select-bordered w-full" } %>
              </div>

              <div class="form-control">
                <%= f.label :store_name, class: "label" do %>
                  <span class="label-text text-sm font-medium">Â∫óËàóÂêçÔºàÊâãÂÖ•ÂäõÔºâ</span>
                <% end %>
                <%= f.text_field :store_name,
                    class: "input input-bordered w-full",
                    placeholder: "Â∫óËàó„ÇíÈÅ∏Êäû„Åó„Å™„ÅÑÂ†¥Âêà„ÅØÊâãÂÖ•Âäõ" %>
              </div>

              <div class="form-control" data-controller="geolocation">
                <%= f.label :departure_location, class: "label" do %>
                  <span class="label-text text-sm font-medium">Âá∫Áô∫Âú∞ÁÇπ</span>
                <% end %>
                <div class="flex gap-2">
                  <%= f.text_field :departure_location,
                      class: "input input-bordered flex-1 min-w-0",
                      placeholder: "ÁèæÂú®Âú∞„Éú„Çø„É≥„ÅßÂèñÂæó",
                      data: { geolocation_target: "addressField" } %>
                  <button type="button"
                          class="btn btn-secondary flex-shrink-0"
                          data-geolocation-target="button"
                          data-action="click->geolocation#getCurrentLocation">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                  </button>
                </div>
                <%= f.hidden_field :departure_latitude, data: { geolocation_target: "latitudeField" } %>
                <%= f.hidden_field :departure_longitude, data: { geolocation_target: "longitudeField" } %>
              </div>
            </div>
          </div>

          <!-- ÁµåÁî±Âú∞ -->
          <div class="card bg-base-200">
            <div class="card-body">
              <h3 class="card-title text-lg">üîÑ ÁµåÁî±Âú∞Ôºà‰ªªÊÑèÔºâ</h3>

              <div data-controller="waypoints"
                   data-waypoints-count-value="<%= @driving_record.waypoints.size %>"
                   data-waypoints-max-waypoints-value="10">
                <div data-waypoints-target="container">
                  <% @driving_record.waypoints.each_with_index do |waypoint, index| %>
                    <div class="border-2 border-base-300 p-4 rounded-lg mb-4" data-waypoint-item>
                      <%= f.fields_for :waypoints, waypoint, child_index: index do |waypoint_form| %>
                        <div class="flex justify-between items-center mb-2">
                          <label class="label-text font-bold">ÁµåÁî±Âú∞<%= index + 1 %></label>
                          <button type="button"
                                  class="btn btn-error btn-xs"
                                  data-action="click->waypoints#removeWaypoint">
                            ‚úï ÂâäÈô§
                          </button>
                        </div>

                        <%= waypoint_form.hidden_field :sequence, value: index + 1 %>
                        <%= waypoint_form.hidden_field :_destroy %>

                        <div class="form-control" data-controller="geolocation">
                          <div class="join w-full">
                            <%= waypoint_form.text_field :location,
                                class: "input input-bordered input-sm join-item flex-1",
                                placeholder: "‰æãÔºöÁ¶èÂ≤°ÁúåÁ¶èÂ≤°Â∏ÇÂçöÂ§öÂå∫‰∏≠Ê¥≤4-5-6",
                                data: { geolocation_target: "addressField" } %>
                            <button type="button"
                                    class="btn btn-secondary btn-sm join-item"
                                    data-geolocation-target="button"
                                    data-action="click->geolocation#getCurrentLocation">
                              üìç ÁèæÂú®Âú∞
                            </button>
                          </div>
                          <%= waypoint_form.hidden_field :latitude, data: { geolocation_target: "latitudeField" } %>
                          <%= waypoint_form.hidden_field :longitude, data: { geolocation_target: "longitudeField" } %>
                        </div>
                      <% end %>
                    </div>
                  <% end %>
                </div>

                <button type="button"
                        class="btn btn-outline btn-sm"
                        data-action="click->waypoints#addWaypoint">
                  ‚ûï ÁµåÁî±Âú∞„ÇíËøΩÂä†
                </button>

                <!-- ÁµåÁî±Âú∞„ÉÜ„É≥„Éó„É¨„Éº„Éà -->
                <template data-waypoints-target="template">
                  <div class="border-2 border-dashed border-base-300 p-4 rounded-lg mb-4" data-waypoint-item>
                    <%= f.fields_for :waypoints, Waypoint.new, child_index: 'NEW_RECORD' do |waypoint_form| %>
                      <div class="flex justify-between items-center mb-2">
                        <label class="label-text font-bold">ÁµåÁî±Âú∞SEQUENCE</label>
                        <button type="button"
                                class="btn btn-error btn-xs"
                                data-action="click->waypoints#removeWaypoint">
                          ‚úï ÂâäÈô§
                        </button>
                      </div>

                      <%= waypoint_form.hidden_field :sequence, value: 'SEQUENCE' %>
                      <%= waypoint_form.hidden_field :_destroy %>

                      <div class="form-control" data-controller="geolocation">
                        <div class="join w-full">
                          <%= waypoint_form.text_field :location,
                              class: "input input-bordered input-sm join-item flex-1",
                              placeholder: "‰æãÔºöÁ¶èÂ≤°ÁúåÁ¶èÂ≤°Â∏ÇÂçöÂ§öÂå∫‰∏≠Ê¥≤4-5-6",
                              data: { geolocation_target: "addressField" } %>
                          <button type="button"
                                  class="btn btn-secondary btn-sm join-item"
                                  data-geolocation-target="button"
                                  data-action="click->geolocation#getCurrentLocation">
                            üìç ÁèæÂú®Âú∞
                          </button>
                        </div>
                        <%= waypoint_form.hidden_field :latitude, data: { geolocation_target: "latitudeField" } %>
                        <%= waypoint_form.hidden_field :longitude, data: { geolocation_target: "longitudeField" } %>
                      </div>
                    <% end %>
                  </div>
                </template>
              </div>
            </div>
          </div>

          <!-- Âà∞ÁùÄ„ÉªÈÅãËª¢ÊÉÖÂ†± -->
          <div class="card bg-base-200">
            <div class="card-body">
              <h3 class="card-title text-lg">üèÅ Âà∞ÁùÄ„ÉªÈÅãËª¢ÊÉÖÂ†±</h3>

              <div class="form-control">
                <%= f.label :arrival_datetime, class: "label" do %>
                  <span class="label-text">Âà∞ÁùÄÊó•ÊôÇ</span>
                <% end %>
                <%= f.datetime_local_field :arrival_datetime,
                    class: "input input-bordered w-full" %>
              </div>

              <div class="form-control" data-controller="geolocation">
                <%= f.label :destination, "ÁõÆÁöÑÂú∞", class: "label" %>
                <div class="join w-full">
                  <%= f.text_field :destination,
                      class: "input input-bordered join-item flex-1",
                      placeholder: "‰æãÔºöÁ¶èÂ≤°ÁúåÁ¶èÂ≤°Â∏ÇÂçöÂ§öÂå∫ÂçöÂ§öÈßÖÂâç3-2-1",
                      data: { geolocation_target: "addressField" } %>
                  <button type="button"
                          class="btn btn-secondary join-item"
                          data-geolocation-target="button"
                          data-action="click->geolocation#getCurrentLocation">
                    üìç ÁèæÂú®Âú∞
                  </button>
                </div>
                <%= f.hidden_field :destination_latitude, data: { geolocation_target: "latitudeField" } %>
                <%= f.hidden_field :destination_longitude, data: { geolocation_target: "longitudeField" } %>
              </div>

              <div class="form-control">
                <%= f.label :customer_id, "È°ßÂÆ¢", class: "label" %>
                <%= f.collection_select :customer_id,
                    Customer.all, :id, :name,
                    { prompt: "È°ßÂÆ¢„ÇíÈÅ∏Êäû", include_blank: "È°ßÂÆ¢„Å™„Åó" },
                    { class: "select select-bordered w-full" } %>
              </div>

              <div class="form-control">
                <%= f.label :customer_name, "È°ßÂÆ¢ÂêçÔºàÊâãÂÖ•ÂäõÔºâ", class: "label" %>
                <%= f.text_field :customer_name,
                    class: "input input-bordered w-full",
                    placeholder: "È°ßÂÆ¢„ÇíÈÅ∏Êäû„Åó„Å™„ÅÑÂ†¥Âêà„ÅØÊâãÂÖ•Âäõ" %>
              </div>

              <div class="form-control">
                <%= f.label :vehicle_id, "Ëªä‰∏°", class: "label" %>
                <%= f.collection_select :vehicle_id,
                    Vehicle.all, :id, :vehicle_number,
                    { prompt: "Ëªä‰∏°„ÇíÈÅ∏Êäû" },
                    { class: "select select-bordered w-full" } %>
              </div>

              <div class="form-control">
                <%= f.label :distance, "Ëµ∞Ë°åË∑ùÈõ¢ÔºàkmÔºâ", class: "label" %>
                <%= f.number_field :distance,
                    class: "input input-bordered w-full",
                    step: 0.1,
                    min: 0,
                    placeholder: "‰æãÔºö15.5" %>
              </div>
            </div>
          </div>

          <!-- ÊñôÈáëÊÉÖÂ†± -->
          <div class="card bg-base-200">
            <div class="card-body" data-controller="amount-calculator">
              <h3 class="card-title text-lg">üí∞ ÊñôÈáëÊÉÖÂ†±</h3>

              <div class="form-control">
                <%= f.label :fare_amount, "ÈÅãË≥É", class: "label" %>
                <%= f.number_field :fare_amount,
                    class: "input input-bordered w-full",
                    min: 0,
                    value: @driving_record.fare_amount || 0,
                    data: {
                      amount_calculator_target: "fareAmount",
                      action: "input->amount-calculator#calculate"
                    } %>
              </div>

              <div class="form-control">
                <%= f.label :highway_fee, "È´òÈÄüÊñôÈáë", class: "label" %>
                <%= f.number_field :highway_fee,
                    class: "input input-bordered w-full",
                    min: 0,
                    value: @driving_record.highway_fee || 0,
                    data: {
                      amount_calculator_target: "highwayFee",
                      action: "input->amount-calculator#calculate"
                    } %>
              </div>

              <div class="form-control">
                <%= f.label :parking_fee, "ÈßêËªäÊñôÈáë", class: "label" %>
                <%= f.number_field :parking_fee,
                    class: "input input-bordered w-full",
                    min: 0,
                    value: @driving_record.parking_fee || 0,
                    data: {
                      amount_calculator_target: "parkingFee",
                      action: "input->amount-calculator#calculate"
                    } %>
              </div>

              <div class="form-control">
                <%= f.label :other_fee, "„Åù„ÅÆ‰ªñÊñôÈáë", class: "label" %>
                <%= f.number_field :other_fee,
                    class: "input input-bordered w-full",
                    min: 0,
                    value: @driving_record.other_fee || 0,
                    data: {
                      amount_calculator_target: "otherFee",
                      action: "input->amount-calculator#calculate"
                    } %>
              </div>

              <div class="divider"></div>

              <div class="flex justify-between items-center p-4 bg-primary/10 rounded-lg">
                <span class="text-lg font-bold">ÂêàË®àÈáëÈ°ç</span>
                <span class="text-2xl font-bold text-primary" data-amount-calculator-target="totalAmount">¬•0</span>
              </div>
            </div>
          </div>

          <!-- ÂÇôËÄÉ -->
          <div class="card bg-base-200">
            <div class="card-body">
              <h3 class="card-title text-lg">üìù ÂÇôËÄÉ</h3>

              <div class="form-control">
                <%= f.label :notes, class: "label" do %>
                  <span class="label-text">ÂÇôËÄÉÔºà‰ªªÊÑèÔºâ</span>
                <% end %>
                <%= f.text_area :notes,
                    class: "textarea textarea-bordered w-full",
                    rows: 3,
                    placeholder: "ÁâπË®ò‰∫ãÈ†Ö„Åå„ÅÇ„Çå„Å∞Ë®òÂÖ•„Åó„Å¶„Åè„Å†„Åï„ÅÑ" %>
              </div>
            </div>
          </div>

          <!-- ÈÄÅ‰ø°„Éú„Çø„É≥Ôºà„Çπ„Éû„ÉõÊúÄÈÅ©ÂåñÔºâ -->
          <div class="sticky bottom-16 md:bottom-0 -mx-3 md:mx-0 p-3 md:p-0 bg-base-100 md:bg-transparent border-t md:border-0 border-base-300 md:static">
            <div class="flex flex-col md:flex-row gap-2 md:gap-4 md:justify-end">
              <%= link_to driving_records_path, class: "btn btn-ghost order-3 md:order-1" do %>
                „Ç≠„É£„É≥„Çª„É´
              <% end %>
              <%= f.submit "‰∏ãÊõ∏„Åç‰øùÂ≠ò", name: "save_draft", class: "btn btn-outline btn-primary order-2" %>
              <%= f.submit "ÂÆå‰∫Ü„Åó„Å¶ÁôªÈå≤", name: "save_completed", class: "btn btn-primary btn-lg md:btn-md order-1 md:order-3" %>
            </div>
          </div>

          <%= f.hidden_field :status, value: "draft" %>
        <% end %>
        </div>
      </div>
    </div>
  </div>
</div>
